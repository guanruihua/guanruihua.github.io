"use strict";(self.webpackChunkguanruihua_github_io=self.webpackChunkguanruihua_github_io||[]).push([[982],{4982:(e,t,a)=>{a.r(t),a.d(t,{default:()=>Z});var l=a(4777),r=a(5296),n=a(5186);var o=a(1814);const s=e=>{const t=[],a=[];return(0,o.cy)(e)&&e.forEach(({name:e,value:l})=>{t.push(e),a.push(l)}),{xData:t,yData:a}};var i=Object.defineProperty,c=Object.defineProperties,u=Object.getOwnPropertyDescriptors,d=Object.getOwnPropertySymbols,m=Object.prototype.hasOwnProperty,p=Object.prototype.propertyIsEnumerable,y=(e,t,a)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,h=(e,t)=>{for(var a in t||(t={}))m.call(t,a)&&y(e,a,t[a]);if(d)for(var a of d(t))p.call(t,a)&&y(e,a,t[a]);return e},v=(e,t)=>c(e,u(t));const g={dataZoom:[{show:!0,type:"slider",startValue:0,yAxisIndex:[0]}],grid:{top:"10%",left:"8%",right:"5%",bottom:"17%",containLabel:!0},tooltip:{trigger:"axis",axisPointer:{type:"shadow"}}},f=e=>{const{data:t=[]}=e,{xData:a=[],yData:l=[]}=s(t);return v(h({},g),{xAxis:{type:"value",boundaryGap:!1,minInterval:1,axisLabel:{clickable:!1}},yAxis:{type:"category",boundaryGap:!0,data:a,axisLabel:{show:!0,clickable:!1,lineStyle:{color:"#f2f2f2"},formatter:function(e){let t=e;return t.length>20&&(t=t.substr(0,20)+"..."),t}}},series:[{data:l,type:"bar",label:{show:!0,position:"right",color:"#862633"}}]})},b=f,w={zh_CN:{total:"总数",drawChart:"图表已绘制成功完成",startFindData:"开始获取系统数据...",endFindData:"获取系统数据完成, 并开始分析..."},en_US:{total:"Total",drawChart:"The chart has been successfully drawn",startFindData:"Start retrieving system data ..",endFindData:"Get system data completed and start analysis. .."}},x=(e,t)=>{var a,l;return(null==(a=null==w?void 0:w[e])?void 0:a[t])||(null==(l=w.en_US)?void 0:l[t])||t},E={bottom:"2%",left:"2%",type:"scroll",textStyle:{align:"left",verticalAlign:"middle",rich:{name:{color:"rgba(0,0,0,0.5)",fontSize:12},value:{color:"rgba(0,0,0,0.5)",fontSize:12},rate:{color:"rgba(0,0,0,0.9)",fontSize:12}}}},_=(e,t={})=>{const{title:a}=t;let l={};if("draw_bar_chart"===e&&(l=f(t)),"draw_x_bar_chart"===e&&(l=b(t)),"draw_y_bar_chart"===e&&(l=(e=>{const{data:t=[]}=e,{xData:a=[],yData:l=[]}=s(t);return v(h({},g),{xAxis:{type:"category",data:a},yAxis:{type:"value"},series:[{data:l,type:"bar"}]})})(t)),"draw_pie_chart"===e&&(l=(e=>{const{title:t,lang:a="en_US",data:l=[]}=e,r={};if((0,o.cy)(l)&&l.length>10){const e=l.slice().sort((e,t)=>t-e).slice(0,10).map(e=>e.name);l.forEach(({name:t})=>{r[t]=e.includes(t)})}return{tooltip:{trigger:"item"},legend:E,graphic:{type:"text",left:"center",top:"center",style:{text:x(a,"total")+"\n\n"+l.reduce((e,t)=>e+t.value,0),textAlign:"center",fill:"#333",width:30,height:30,fontSize:14}},series:[{name:t,type:"pie",radius:["30%","49%"],avoidLabelOverlap:!0,minShowLabelAngle:5,itemStyle:{borderColor:"#fff",borderWidth:2},emphasis:{itemStyle:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}},data:l}]}})(t)),"draw_line_chart"===e&&(l=(e=>{const{data:t=[]}=e,{xData:a=[],yData:l=[]}=s(t);return{tooltip:{trigger:"axis"},legend:E,xAxis:{type:"category",data:a||[]},yAxis:{type:"value"},series:[{data:l||[],type:"line"}]}})(t)),"draw_lines_chart"===e&&(l=(e=>{const{data:t=[]}=e;let a=[];const l=[];return null==t||t.forEach(e=>{const{name:t}=e;(0,o.Kg)(t)&&(0,o.cy)(e.data)&&(0===a.length&&(a=e.data.map(e=>e.name)),l.push({name:t,type:"line",stack:"Total",data:e.data.map(e=>e.value)}))}),{tooltip:{trigger:"axis"},legend:E,xAxis:{type:"category",boundaryGap:!1,data:a||[]},yAxis:{type:"value"},series:l||[]}})(t)),(0,o.B9)(l))return a&&(l.title={text:a,left:"center"}),l},C={type:"object",properties:{title:{type:"string",description:"图表的标题, 请根据上下文生成"},data:{type:"array",description:"data是个数组有两个属性, 一个属性是name, 第二个value, 标识该项的值; 这两个属性的值是必填的"}},required:["title","data"]},N=[{type:"function",function:{name:"draw_bar_chart",description:"绘制柱状图",parameters:C}},{type:"function",function:{name:"draw_x_bar_chart",description:"绘制水平柱状图",parameters:C}},{type:"function",function:{name:"draw_y_bar_chart",description:"绘制垂直柱状图",parameters:C}},{type:"function",function:{name:"draw_pie_chart",description:"绘制饼图",parameters:C}},{type:"function",function:{name:"draw_line_chart",description:"绘制折线图",parameters:C}},{type:"function",function:{name:"draw_lines_chart",description:"绘制多条折线图或者折线图堆叠",parameters:{type:"object",description:"多条折线的配置",properties:{title:{type:"string",description:"图表的标题, 请根据上下文生成"},data:{type:"array",description:"每条数据条线的相关数据",properties:{name:{type:"string",description:"名称"},data:{type:"array",description:"单条数据条线的相关数据",properties:{name:{type:"string",description:"名称"},value:{type:"number",description:"值"}}}}}},required:["title","data"]}}}],P=N.map(e=>e.function.name);var k=a(1938),O=Object.defineProperty,S=Object.getOwnPropertySymbols,A=Object.prototype.hasOwnProperty,T=Object.prototype.propertyIsEnumerable,D=(e,t,a)=>t in e?O(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,L=(e,t)=>{for(var a in t||(t={}))A.call(t,a)&&D(e,a,t[a]);if(S)for(var a of S(t))T.call(t,a)&&D(e,a,t[a]);return e};const M=e=>{const{url:t,model:a,apiKey:l}=e;return{sendMessage(e){return r=this,n=null,s=function*(){var r,n,s,i,c,u,d,m;const{messages:p,tools:y,headers:h={},params:v={}}=e;if(!t)return console.error("LLM / sendMessage / Parameter url are required"),{};if(!(0,o.vH)(p))return console.error("LLM / sendMessage / Parameter messages are incorrect"),{};if(y&&!(0,o.vH)(y))return console.error("LLM / sendMessage / Parameter tools are incorrect"),{};(0,o.vH)(y)&&!v.tools&&(v.tools=y),l&&!h.Authorization&&(h.Authorization=`Bearer ${l}`);const g=yield k.A.post(t,L({model:null!=(r=e.model)?r:a,messages:p,stream:!1},v),{headers:L({"Content-Type":"application/json"},h)}).catch(e=>(console.error(e),{}));return(null==(i=null==(s=null==(n=null==g?void 0:g.data)?void 0:n.choices)?void 0:s[0])?void 0:i.message)||(null==(m=null==(d=null==(u=null==(c=null==g?void 0:g.data)?void 0:c.data)?void 0:u.choices)?void 0:d[0])?void 0:m.message)},new Promise((e,t)=>{var a=e=>{try{o(s.next(e))}catch(e){t(e)}},l=e=>{try{o(s.throw(e))}catch(e){t(e)}},o=t=>t.done?e(t.value):Promise.resolve(t.value).then(a,l);o((s=s.apply(r,n)).next())});var r,n,s}}};var R=Object.defineProperty,j=Object.getOwnPropertySymbols,K=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,U=(e,t,a)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,z=(e,t,a)=>new Promise((l,r)=>{var n=e=>{try{s(a.next(e))}catch(e){r(e)}},o=e=>{try{s(a.throw(e))}catch(e){r(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,o);s((a=a.apply(e,t)).next())});const H=e=>{const{model:t,url:a,apiKey:l,SystemPrompt:r,lang:n="en_US",addChartTool:s=!0,functionCall:i={},config:c={}}=e;let{tools:u=[],ChartToolTypes:d=[]}=e;if(s){const e=u.map(e=>e.function.name).filter(Boolean);P.forEach((t,a)=>{e.includes(t)||d.includes(t)||(d.push(t),u.push(N[a]))})}return{handleChat:e=>z(null,null,function*(){var m,p;const y=M({model:t,url:a,apiKey:l});if(!y)return void console.error("LLM init error");const{message:h,messages:v=[],callback:g,callbackMessage:f}=e;if(c.enabledRAG)try{const e=yield k.A.post(" http://localhost:2400/rag",{message:h});if(console.log("RAG Data: ",e.data),200===(null==(m=null==e?void 0:e.data)?void 0:m.code)){const t=null==(p=null==e?void 0:e.data)?void 0:p.data,a=`你是一个客服助手，请严格根据以下信息回答：${JSON.stringify(t)}`;v.unshift({role:"system",content:a})}}catch(e){console.error(e)}if(h&&v.push({role:"user",content:h}),r&&v.unshift({role:"system",content:r}),0===v.length)return;null==g||g({role:"user",content:h});const b=e.tools?e.tools:e.expandTools?[...u,...e.expandTools]:u,w=yield y.sendMessage({messages:v,tools:b});console.log("llm: ",w),v.push(w);const E=e=>z(null,null,function*(){var t;console.log("🚀 ~ handleToolCall ~ msg:",e);const a=null==(t=null==e?void 0:e.tool_calls)?void 0:t[0],l=null==a?void 0:a.function;if((0,o.Kg)(null==l?void 0:l.name)){const e=((e,t={})=>{var a;try{const l=null!=(a=JSON.parse(e))?a:t;return(0,o.Kg)(null==l?void 0:l.data)&&(l.data=JSON.parse(l.data)),l}catch(e){return console.error(e),t}})(l.arguments);let t="";if(d.includes(l.name))try{const a={role:"assistant",content:"",toolType:l.name,chartTitle:null==e?void 0:e.title,chartData:null==e?void 0:e.data};s&&(a.chartOptions=_(l.name,((e,t)=>{for(var a in t||(t={}))K.call(t,a)&&U(e,a,t[a]);if(j)for(var a of j(t))G.call(t,a)&&U(e,a,t[a]);return e})({lang:n},e))),null==g||g(a),t=x(n,"drawChart")}catch(e){console.error(e)}else if(i[l.name]){const a=i[l.name];null==g||g({role:"assistant",content:x(n,"startFindData"),toolType:"assistant-process"}),t=yield a(e),null==g||g({role:"assistant",content:x(n,"endFindData"),toolType:"assistant-process"})}(0,o.Kg)(t)||(t=JSON.stringify(t)),v.push({role:"tool",tool_call_id:a.id,name:l.name,content:t});const r=yield y.sendMessage({messages:v,tools:b});return console.log("🚀 ~ handleToolCall ~ msgNext:",r),yield E(r)}return null==f||f(v),null==g?void 0:g({role:"assistant",content:(null==e?void 0:e.content)||""})});return yield E(w)})}},F=[{label:"deepseek-chat",value:"deepseek-chat"},{label:"deepseek-reasoner",value:"deepseek-reasoner"},{label:"llama3.1",value:"llama3.1"},{label:"llama3.2",value:"llama3.2"},{label:"Custom",value:"Custom"}],I=[{label:"https://api.deepseek.com/v1/chat/completions",value:"https://api.deepseek.com/v1/chat/completions"},{label:"http://localhost:2400/ollama/chat",value:"http://localhost:2400/ollama/chat"},{label:"Custom",value:"Custom"}],B=[{value:"1",label:"使用随机数据绘制柱状图"},{value:"2",label:"你是"}];var J=(e,t,a)=>new Promise((l,r)=>{var n=e=>{try{s(a.next(e))}catch(e){r(e)}},o=e=>{try{s(a.throw(e))}catch(e){r(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,o);s((a=a.apply(e,t)).next())});const $=()=>{const[e,t]=(()=>{const e=r.useRef(null),t=r.useRef(null);return[e,(a=500)=>{t.current&&clearTimeout(t.current),t.current=setTimeout(()=>{const a=e.current;a&&a.scrollTo(0,a.scrollHeight),t&&clearTimeout(t.current)},a)}]})(),[a,l]=(0,n.xI)({model:"deepseek-chat",customModel:!1,enabledRAG:!1,apiKey:"",url:"https://api.deepseek.com/v1/chat/completions",customURL:!1,selectModelType:"",userPrompt:"你好",messages:[],history:[]},"tool/ai-chat/cache");return r.useEffect(()=>{J(null,null,function*(){t()})},[]),{state:a,setState:l,historyRef:e,handleChat:e=>J(null,null,function*(){if(!a.userPrompt||!a.apiKey)return;const r=H({apiKey:a.apiKey,model:a.model,url:a.url,SystemPrompt:"你的回答应基于以下规则：\n1. 根据用户提问的语言（如中文或英文）来回答。\n2. 提供的tools 里有绘图功能。\n3. 直接回答问题，不要包含任何推理过程（如“让我想想”“首先，我需要...”）。\n禁止行为：\n- 禁止生成图表的图片\n",lang:"en"===localStorage.language?"en_US":"zh_CN",config:{enabledRAG:a.enabledRAG}});yield null==r?void 0:r.handleChat({message:e||a.userPrompt,messages:a.messages,callback:e=>{e&&((0,o.cy)(a.history)||(a.history=[]),a.history.push(e),l(a),t())}})}),handleClearHistory:()=>{l({history:[]})}}};var q=a(8853),V=a(1626);const W=({value:e=""})=>r.createElement(q.oz,{remarkPlugins:[V.A]},e);var X=(e,t,a)=>new Promise((l,r)=>{var n=e=>{try{s(a.next(e))}catch(e){r(e)}},o=e=>{try{s(a.throw(e))}catch(e){r(e)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,o);s((a=a.apply(e,t)).next())});function Z(){var e;const{historyRef:t,state:a,setState:n,handleChat:o,handleClearHistory:s}=$(),[i,c]=r.useState(!1),u=e=>X(null,null,function*(){i||(c(!0),yield o(e),c(!1))});return r.createElement("div",{className:"tool-ai-chat"},r.createElement("div",{className:"left-aside"},r.createElement(l.i,{className:"ai-model"},r.createElement("div",{className:"item"},r.createElement("div",{className:"label"}," Api Key"),r.createElement(l.pd,{value:a.apiKey,onChange:e=>n({apiKey:e.target.value})})),r.createElement("div",{className:"item"},r.createElement("div",{className:"label"},"Model"),r.createElement(l.so,{className:"model-box"},F.map(({label:e,value:t})=>r.createElement(l.i,{key:t,className:"item",classNames:{select:a.customModel?"Custom"===t:t===a.model},onClick:()=>{var e;n("Custom"!==(e=t)?{model:e,customModel:!1}:{model:"",customModel:!0})}},e)),a.customModel&&r.createElement(l.pd,{value:a.model,onChange:e=>n({model:e.target.value})}))),r.createElement("div",{className:"item"},r.createElement("div",{className:"label"},"URL"),r.createElement(l.so,{className:"url-box"},I.map(({label:e,value:t})=>r.createElement(l.i,{key:t,className:"item",classNames:{select:a.customURL?"Custom"===t:t===a.url},onClick:()=>{var e;n("Custom"!==(e=t)?{url:e,customURL:!1}:{url:"",customURL:!0})}},e)),a.customURL&&r.createElement(l.pd,{value:a.url,onChange:e=>n({url:e.target.value})})))),r.createElement(l.$n,{onClick:s},"Clear History"),r.createElement(l.$n,{type:a.enabledRAG?"primary":"default",onClick:()=>{n({enabledRAG:!a.enabledRAG})}},"Enabled RAG")),r.createElement("div",{className:"chat-container"},r.createElement("div",{className:"chat-history",ref:t},null==(e=null==a?void 0:a.history)?void 0:e.map((e,t)=>{const{role:a,content:n,chartOptions:o,toolType:s}=e;return o?r.createElement(l.i,{key:t,classNames:[a,"chart",s]},r.createElement(l.t1,{style:{minHeight:300},options:o})):r.createElement(l.i,{key:t,className:a},r.createElement("div",{className:"content markdown"},r.createElement(W,{value:n})))})),r.createElement("div",{className:"user-prompt"},r.createElement("textarea",{value:a.userPrompt,onKeyDown:e=>{"Enter"===e.code&&(e.preventDefault(),u())},onChange:e=>{n({userPrompt:e.target.value})}}),r.createElement("div",{className:"user-prompt-controls"},r.createElement(l.i,{className:"btn-send",classNames:{disabled:i||!(null==a?void 0:a.userPrompt)},onClick:()=>u()},r.createElement("svg",{xmlns:"http://www.w3.org/2000/svg",width:"1em",height:"1em",viewBox:"0 0 24 24"},r.createElement("path",{fill:"currentColor",d:"M20.04 2.323c1.016-.355 1.992.621 1.637 1.637l-5.925 16.93c-.385 1.098-1.915 1.16-2.387.097l-2.859-6.432l4.024-4.025a.75.75 0 0 0-1.06-1.06l-4.025 4.024l-6.432-2.859c-1.063-.473-1-2.002.097-2.387z"})))))),r.createElement("div",{className:"right-aside"},r.createElement("div",{className:"suggest-box"},B.map((e,t)=>{const{value:a,label:l}=e;return r.createElement("div",{key:t,className:"suggest-item",onClick:()=>u(l)},l)}))))}}}]);